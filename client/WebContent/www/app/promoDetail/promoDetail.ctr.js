/// <reference path="../app.d.ts" />
var Tomedescontos;
(function (Tomedescontos) {
    var PromoDetailController = (function () {
        function PromoDetailController($scope, $http, $stateParams, $q, $translate, promoService) {
            var _this = this;
            this.$scope = $scope;
            this.$http = $http;
            this.$stateParams = $stateParams;
            this.$q = $q;
            this.$translate = $translate;
            this.promoService = promoService;
            /* Private variables come here. */
            this.promo = [];
            this.title = "";
            this.wtsappLink = "";
            var promoJson = {};
            var lineCharIcon = $('.line.chart.icon');
            var statistics = $('.ui.statistics .statistic');
            /* Triggering line chart icon popup to explain to the user where we found the price history and how it could help him/her. */
            lineCharIcon.popup({
                title: 'Não tem certeza se será um bom negócio?',
                content: 'Compare o preço atual do produto com o histórico de preços fornecidos pelo Buscapé.' +
                    ' Confere aqui embaixo!',
                inline: true
            });
            lineCharIcon.popup('show');
            statistics.transition({
                animation: 'scale in',
                duration: 1000,
                interval: 200
            });
            /* Saving promo title in a short variable. Im' lazy! ;D */
            this.title = this.$stateParams.title;
            this.promo["shareUrl"] = window.location.href;
            /* (1) retrieving promo data from our database. */
            this.promoService.findPromoByTitle(this.title).then(function (data) {
                _this.promo["url"] = data.url;
                _this.promo["img"] = data.img;
                _this.promo["id"] = data._id;
            });
            this.splittingPriceFromTitle(this.title);
            this.promoService.getPromoDetail(this.improvingTheTitle(this.title)).then(function (data) {
                _this.promo["maxPrice"] = data.maxPrice;
                _this.promo["minPrice"] = data.minPrice;
                /* If promo does not have an image set and we found one through buscape api, then
                   set it to image atribute and update it in the database. */
                if (!_this.promo["img"] && data.image) {
                    _this.promo["img"] = data.image;
                    var test = {
                        'id': _this.promo["id"],
                        'img': _this.promo["img"]
                    };
                    /* I'm updating just the promo image at this moment, but I'll update all new data
                    regarding the promo later. */
                    _this.promoService.updatePromoData(test);
                }
            });
        }
        PromoDetailController.prototype.improvingTheTitle = function (title) {
            var result = [];
            /* all regex patterns we will use further */
            var rgx0 = new RegExp("\[.*?\]", "g");
            var rgx1 = new RegExp("(R\$ (\d{1,7}(\.\d{3})*|\d+)(\,\d{2})?)", "g");
            var rgx2 = new RegExp("(R\$(\d{1,7}(\.\d{3})*|\d+)(\,\d{2})?)", "g");
            var rgx3 = new RegExp("[0-9]+(,[0-9]+)", "g");
            var rgx4 = new RegExp("[/!,@#$%^&*'\"+=-]", "g");
            var rgx5 = new RegExp("\(|\)", "g");
            var rgx6 = new RegExp("\s\s+", "g");
            /* removing all texts between brackets */
            if (title.search(rgx0) != -1) {
                title = title.replace(rgx0, '');
            }
            /* removing price tags */
            if (title.search(rgx1) != -1) {
                title = title.replace(rgx1, '');
            }
            if (title.search(rgx2) != -1) {
                title = title.replace(rgx2, '');
            }
            /* removing decimal numbers */
            if (title.search(rgx3) != -1) {
                title = title.replace(rgx3, '');
            }
            /* removing special characters */
            if (title.search(rgx4) != -1) {
                title = title.replace(rgx4, '');
            }
            if (title.search(rgx5) != -1) {
                title = title.replace(rgx5, '');
            }
            /* replacing double whitespaces by single whitespace */
            if (title.search(rgx6) != -1) {
                title = title.replace(rgx6, ' ');
            }
            /* splitting the titleand put it into array */
            title = title.trim().split(" ");
            /* getting just 5 words at maximum from the title to compose the new title */
            for (var i = 0; i < 7; i++) {
                result.push(title[i]);
            }
            return result.join(' ');
        };
        PromoDetailController.prototype.splittingPriceFromTitle = function (txt) {
            var rgx10 = /(R\$ (\d{1,7}(\.\d{3})*|\d+)(\,\d{2})?)/g;
            var rgx11 = /(R\$(\d{1,7}(\.\d{3})*|\d+)(\,\d{2})?)/g;
            if (txt.search(rgx10) != -1) {
                this.promo["title"] = txt.replace(rgx10, '');
                this.promo["price"] = txt.match(rgx10)[0];
            }
            if (txt.search(rgx11) != -1) {
                this.promo["title"] = txt.replace(rgx11, '');
                this.promo["price"] = txt.match(rgx11)[0];
            }
        };
        return PromoDetailController;
    }());
    Tomedescontos.PromoDetailController = PromoDetailController;
})(Tomedescontos || (Tomedescontos = {}));
app.controller('PromoDetailController', ['$scope', '$http', '$stateParams', '$q', '$translate', 'PromoService', Tomedescontos.PromoDetailController]);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb21vRGV0YWlsL3Byb21vRGV0YWlsLmN0ci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxvQ0FBb0M7QUFFcEMsSUFBTyxhQUFhLENBaUluQjtBQWpJRCxXQUFPLGFBQWEsRUFBQyxDQUFDO0lBRWxCO1FBT0ksK0JBQW9CLE1BQWlCLEVBQ3pCLEtBQXNCLEVBQ3RCLFlBQWlCLEVBQ2pCLEVBQWdCLEVBQ2hCLFVBQTBDLEVBQzFDLFlBQTBCO1lBWjFDLGlCQThIQztZQXZIdUIsV0FBTSxHQUFOLE1BQU0sQ0FBVztZQUN6QixVQUFLLEdBQUwsS0FBSyxDQUFpQjtZQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBSztZQUNqQixPQUFFLEdBQUYsRUFBRSxDQUFjO1lBQ2hCLGVBQVUsR0FBVixVQUFVLENBQWdDO1lBQzFDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1lBVnRDLGtDQUFrQztZQUMxQixVQUFLLEdBQVUsRUFBRSxDQUFDO1lBQ2xCLFVBQUssR0FBVyxFQUFFLENBQUM7WUFDbkIsZUFBVSxHQUFXLEVBQUUsQ0FBQztZQVN4QixJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFDbkIsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDekMsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDLDJCQUEyQixDQUFDLENBQUM7WUFDaEQsNkhBQTZIO1lBQzdILFlBQVksQ0FBQyxLQUFLLENBQUM7Z0JBQ2YsS0FBSyxFQUFFLHlDQUF5QztnQkFDaEQsT0FBTyxFQUFFLHFGQUFxRjtvQkFDckYsd0JBQXdCO2dCQUNqQyxNQUFNLEVBQUUsSUFBSTthQUNmLENBQUMsQ0FBQztZQUNILFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFM0IsVUFBVSxDQUFDLFVBQVUsQ0FBQztnQkFDbEIsU0FBUyxFQUFHLFVBQVU7Z0JBQ3RCLFFBQVEsRUFBSSxJQUFJO2dCQUNoQixRQUFRLEVBQUksR0FBRzthQUNsQixDQUFDLENBQUM7WUFHSCwwREFBMEQ7WUFDMUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQztZQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBRTlDLGtEQUFrRDtZQUNsRCxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUFJO2dCQUVyRCxLQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7Z0JBQzdCLEtBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztnQkFDN0IsS0FBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBRWhDLENBQUMsQ0FBQyxDQUFBO1lBRUYsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBSTtnQkFDM0UsS0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUN2QyxLQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBRXZDOzZFQUM2RDtnQkFDN0QsRUFBRSxDQUFBLENBQUMsQ0FBQyxLQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO29CQUNsQyxLQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7b0JBRS9CLElBQUksSUFBSSxHQUFHO3dCQUNQLElBQUksRUFBRSxLQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzt3QkFDdEIsS0FBSyxFQUFFLEtBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO3FCQUMzQixDQUFBO29CQUdEO2lEQUM2QjtvQkFDN0IsS0FBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzVDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUM7UUFFTSxpREFBaUIsR0FBeEIsVUFBeUIsS0FBVTtZQUUvQixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsNENBQTRDO1lBQzVDLElBQUksSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN0QyxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyx5Q0FBeUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN0RSxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyx3Q0FBd0MsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNyRSxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM5QyxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNqRCxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDcEMsSUFBSSxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRXBDLHlDQUF5QztZQUN6QyxFQUFFLENBQUEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFBQyxDQUFDO1lBRWpFLHlCQUF5QjtZQUN6QixFQUFFLENBQUEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFBQyxDQUFDO1lBQ2pFLEVBQUUsQ0FBQSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUFDLENBQUM7WUFFakUsOEJBQThCO1lBQzlCLEVBQUUsQ0FBQSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUFDLENBQUM7WUFFakUsaUNBQWlDO1lBQ2pDLEVBQUUsQ0FBQSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUFDLENBQUM7WUFDakUsRUFBRSxDQUFBLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQUMsQ0FBQztZQUVqRSx1REFBdUQ7WUFDdkQsRUFBRSxDQUFBLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQUMsQ0FBQztZQUVsRSw4Q0FBOEM7WUFDOUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFaEMsNkVBQTZFO1lBQzdFLEdBQUcsQ0FBQSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsQ0FBQztZQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTVCLENBQUM7UUFFTSx1REFBdUIsR0FBOUIsVUFBK0IsR0FBVztZQUV0QyxJQUFJLEtBQUssR0FBRywwQ0FBMEMsQ0FBQztZQUN2RCxJQUFJLEtBQUssR0FBRyx5Q0FBeUMsQ0FBQztZQUV0RCxFQUFFLENBQUEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLENBQUM7WUFFRCxFQUFFLENBQUEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLENBQUM7UUFDTCxDQUFDO1FBRUwsNEJBQUM7SUFBRCxDQTlIQSxBQThIQyxJQUFBO0lBOUhZLG1DQUFxQix3QkE4SGpDLENBQUE7QUFDTCxDQUFDLEVBaklNLGFBQWEsS0FBYixhQUFhLFFBaUluQjtBQUNELEdBQUcsQ0FBQyxVQUFVLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxhQUFhLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6InByb21vRGV0YWlsL3Byb21vRGV0YWlsLmN0ci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9hcHAuZC50c1wiIC8+XG5cbm1vZHVsZSBUb21lZGVzY29udG9zIHtcblxuICAgIGV4cG9ydCBjbGFzcyBQcm9tb0RldGFpbENvbnRyb2xsZXIge1xuXG4gICAgICAgIC8qIFByaXZhdGUgdmFyaWFibGVzIGNvbWUgaGVyZS4gKi9cbiAgICAgICAgcHJpdmF0ZSBwcm9tbzogYW55W10gPSBbXTtcbiAgICAgICAgcHJpdmF0ZSB0aXRsZTogU3RyaW5nID0gXCJcIjtcbiAgICAgICAgcHJpdmF0ZSB3dHNhcHBMaW5rOiBTdHJpbmcgPSBcIlwiO1xuICAgICAgICBcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSAkc2NvcGU6IG5nLklTY29wZSwgXG4gICAgICAgICAgICBwcml2YXRlICRodHRwOiBuZy5JSHR0cFNlcnZpY2UsXG4gICAgICAgICAgICBwcml2YXRlICRzdGF0ZVBhcmFtczogYW55LCBcbiAgICAgICAgICAgIHByaXZhdGUgJHE6IG5nLklRU2VydmljZSwgXG4gICAgICAgICAgICBwcml2YXRlICR0cmFuc2xhdGU6IG5nLnRyYW5zbGF0ZS5JVHJhbnNsYXRlU2VydmljZSxcbiAgICAgICAgICAgIHByaXZhdGUgcHJvbW9TZXJ2aWNlOiBQcm9tb1NlcnZpY2UpIHsgICBcblxuICAgICAgICAgICAgICAgIHZhciBwcm9tb0pzb24gPSB7fTtcbiAgICAgICAgICAgICAgICB2YXIgbGluZUNoYXJJY29uID0gJCgnLmxpbmUuY2hhcnQuaWNvbicpO1xuICAgICAgICAgICAgICAgIHZhciBzdGF0aXN0aWNzID0gJCgnLnVpLnN0YXRpc3RpY3MgLnN0YXRpc3RpYycpO1xuICAgICAgICAgICAgICAgIC8qIFRyaWdnZXJpbmcgbGluZSBjaGFydCBpY29uIHBvcHVwIHRvIGV4cGxhaW4gdG8gdGhlIHVzZXIgd2hlcmUgd2UgZm91bmQgdGhlIHByaWNlIGhpc3RvcnkgYW5kIGhvdyBpdCBjb3VsZCBoZWxwIGhpbS9oZXIuICovXG4gICAgICAgICAgICAgICAgbGluZUNoYXJJY29uLnBvcHVwKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdOw6NvIHRlbSBjZXJ0ZXphIHNlIHNlcsOhIHVtIGJvbSBuZWfDs2Npbz8nLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50OiAnQ29tcGFyZSBvIHByZcOnbyBhdHVhbCBkbyBwcm9kdXRvIGNvbSBvIGhpc3TDs3JpY28gZGUgcHJlw6dvcyBmb3JuZWNpZG9zIHBlbG8gQnVzY2Fww6kuJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgQ29uZmVyZSBhcXVpIGVtYmFpeG8hJyxcbiAgICAgICAgICAgICAgICAgICAgaW5saW5lOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbGluZUNoYXJJY29uLnBvcHVwKCdzaG93Jyk7XG5cbiAgICAgICAgICAgICAgICBzdGF0aXN0aWNzLnRyYW5zaXRpb24oe1xuICAgICAgICAgICAgICAgICAgICBhbmltYXRpb24gOiAnc2NhbGUgaW4nLFxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiAgOiAxMDAwLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCAgOiAyMDBcbiAgICAgICAgICAgICAgICB9KTtcblxuXG4gICAgICAgICAgICAgICAgLyogU2F2aW5nIHByb21vIHRpdGxlIGluIGEgc2hvcnQgdmFyaWFibGUuIEltJyBsYXp5ISA7RCAqLyAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMudGl0bGUgPSB0aGlzLiRzdGF0ZVBhcmFtcy50aXRsZTtcbiAgICAgICAgICAgICAgICB0aGlzLnByb21vW1wic2hhcmVVcmxcIl0gPSB3aW5kb3cubG9jYXRpb24uaHJlZjtcblxuICAgICAgICAgICAgICAgIC8qICgxKSByZXRyaWV2aW5nIHByb21vIGRhdGEgZnJvbSBvdXIgZGF0YWJhc2UuICovXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9tb1NlcnZpY2UuZmluZFByb21vQnlUaXRsZSh0aGlzLnRpdGxlKS50aGVuKChkYXRhKT0+e1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9tb1tcInVybFwiXSA9IGRhdGEudXJsO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb21vW1wiaW1nXCJdID0gZGF0YS5pbWc7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvbW9bXCJpZFwiXSA9IGRhdGEuX2lkO1xuXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIHRoaXMuc3BsaXR0aW5nUHJpY2VGcm9tVGl0bGUodGhpcy50aXRsZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9tb1NlcnZpY2UuZ2V0UHJvbW9EZXRhaWwodGhpcy5pbXByb3ZpbmdUaGVUaXRsZSh0aGlzLnRpdGxlKSkudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb21vW1wibWF4UHJpY2VcIl0gPSBkYXRhLm1heFByaWNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb21vW1wibWluUHJpY2VcIl0gPSBkYXRhLm1pblByaWNlO1xuXG4gICAgICAgICAgICAgICAgICAgIC8qIElmIHByb21vIGRvZXMgbm90IGhhdmUgYW4gaW1hZ2Ugc2V0IGFuZCB3ZSBmb3VuZCBvbmUgdGhyb3VnaCBidXNjYXBlIGFwaSwgdGhlblxuICAgICAgICAgICAgICAgICAgICAgICBzZXQgaXQgdG8gaW1hZ2UgYXRyaWJ1dGUgYW5kIHVwZGF0ZSBpdCBpbiB0aGUgZGF0YWJhc2UuICovXG4gICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLnByb21vW1wiaW1nXCJdICYmIGRhdGEuaW1hZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvbW9bXCJpbWdcIl0gPSBkYXRhLmltYWdlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVzdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaWQnOiB0aGlzLnByb21vW1wiaWRcIl0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltZyc6IHRoaXMucHJvbW9bXCJpbWdcIl1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvKiBJJ20gdXBkYXRpbmcganVzdCB0aGUgcHJvbW8gaW1hZ2UgYXQgdGhpcyBtb21lbnQsIGJ1dCBJJ2xsIHVwZGF0ZSBhbGwgbmV3IGRhdGFcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2FyZGluZyB0aGUgcHJvbW8gbGF0ZXIuICovXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb21vU2VydmljZS51cGRhdGVQcm9tb0RhdGEodGVzdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBpbXByb3ZpbmdUaGVUaXRsZSh0aXRsZTogYW55KTogU3RyaW5nIHtcblxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xuICAgICAgICAgICAgLyogYWxsIHJlZ2V4IHBhdHRlcm5zIHdlIHdpbGwgdXNlIGZ1cnRoZXIgKi9cbiAgICAgICAgICAgIHZhciByZ3gwID0gbmV3IFJlZ0V4cChcIlxcWy4qP1xcXVwiLCBcImdcIik7XG4gICAgICAgICAgICB2YXIgcmd4MSA9IG5ldyBSZWdFeHAoXCIoUlxcJCAoXFxkezEsN30oXFwuXFxkezN9KSp8XFxkKykoXFwsXFxkezJ9KT8pXCIsIFwiZ1wiKTtcbiAgICAgICAgICAgIHZhciByZ3gyID0gbmV3IFJlZ0V4cChcIihSXFwkKFxcZHsxLDd9KFxcLlxcZHszfSkqfFxcZCspKFxcLFxcZHsyfSk/KVwiLCBcImdcIik7XG4gICAgICAgICAgICB2YXIgcmd4MyA9IG5ldyBSZWdFeHAoXCJbMC05XSsoLFswLTldKylcIiwgXCJnXCIpO1xuICAgICAgICAgICAgdmFyIHJneDQgPSBuZXcgUmVnRXhwKFwiWy8hLEAjJCVeJionXFxcIis9LV1cIiwgXCJnXCIpO1xuICAgICAgICAgICAgdmFyIHJneDUgPSBuZXcgUmVnRXhwKFwiXFwofFxcKVwiLCBcImdcIik7XG4gICAgICAgICAgICB2YXIgcmd4NiA9IG5ldyBSZWdFeHAoXCJcXHNcXHMrXCIsIFwiZ1wiKTtcblxuICAgICAgICAgICAgLyogcmVtb3ZpbmcgYWxsIHRleHRzIGJldHdlZW4gYnJhY2tldHMgKi9cbiAgICAgICAgICAgIGlmKHRpdGxlLnNlYXJjaChyZ3gwKSAhPSAtMSkgeyB0aXRsZSA9IHRpdGxlLnJlcGxhY2Uocmd4MCwgJycpOyB9XG5cbiAgICAgICAgICAgIC8qIHJlbW92aW5nIHByaWNlIHRhZ3MgKi9cbiAgICAgICAgICAgIGlmKHRpdGxlLnNlYXJjaChyZ3gxKSAhPSAtMSkgeyB0aXRsZSA9IHRpdGxlLnJlcGxhY2Uocmd4MSwgJycpOyB9XG4gICAgICAgICAgICBpZih0aXRsZS5zZWFyY2gocmd4MikgIT0gLTEpIHsgdGl0bGUgPSB0aXRsZS5yZXBsYWNlKHJneDIsICcnKTsgfVxuXG4gICAgICAgICAgICAvKiByZW1vdmluZyBkZWNpbWFsIG51bWJlcnMgKi9cbiAgICAgICAgICAgIGlmKHRpdGxlLnNlYXJjaChyZ3gzKSAhPSAtMSkgeyB0aXRsZSA9IHRpdGxlLnJlcGxhY2Uocmd4MywgJycpOyB9XG5cbiAgICAgICAgICAgIC8qIHJlbW92aW5nIHNwZWNpYWwgY2hhcmFjdGVycyAqL1xuICAgICAgICAgICAgaWYodGl0bGUuc2VhcmNoKHJneDQpICE9IC0xKSB7IHRpdGxlID0gdGl0bGUucmVwbGFjZShyZ3g0LCAnJyk7IH1cbiAgICAgICAgICAgIGlmKHRpdGxlLnNlYXJjaChyZ3g1KSAhPSAtMSkgeyB0aXRsZSA9IHRpdGxlLnJlcGxhY2Uocmd4NSwgJycpOyB9XG5cbiAgICAgICAgICAgIC8qIHJlcGxhY2luZyBkb3VibGUgd2hpdGVzcGFjZXMgYnkgc2luZ2xlIHdoaXRlc3BhY2UgKi9cbiAgICAgICAgICAgIGlmKHRpdGxlLnNlYXJjaChyZ3g2KSAhPSAtMSkgeyB0aXRsZSA9IHRpdGxlLnJlcGxhY2Uocmd4NiwgJyAnKTsgfVxuXG4gICAgICAgICAgICAvKiBzcGxpdHRpbmcgdGhlIHRpdGxlYW5kIHB1dCBpdCBpbnRvIGFycmF5ICovXG4gICAgICAgICAgICB0aXRsZSA9IHRpdGxlLnRyaW0oKS5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8qIGdldHRpbmcganVzdCA1IHdvcmRzIGF0IG1heGltdW0gZnJvbSB0aGUgdGl0bGUgdG8gY29tcG9zZSB0aGUgbmV3IHRpdGxlICovXG4gICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgNzsgaSsrKXtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0aXRsZVtpXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignICcpO1xuXG4gICAgICAgIH1cblxuICAgICAgICBwdWJsaWMgc3BsaXR0aW5nUHJpY2VGcm9tVGl0bGUodHh0OiBTdHJpbmcpOiB2b2lke1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgcmd4MTAgPSAvKFJcXCQgKFxcZHsxLDd9KFxcLlxcZHszfSkqfFxcZCspKFxcLFxcZHsyfSk/KS9nO1xuICAgICAgICAgICAgdmFyIHJneDExID0gLyhSXFwkKFxcZHsxLDd9KFxcLlxcZHszfSkqfFxcZCspKFxcLFxcZHsyfSk/KS9nO1xuXG4gICAgICAgICAgICBpZih0eHQuc2VhcmNoKHJneDEwKSAhPSAtMSkgeyBcbiAgICAgICAgICAgICAgICB0aGlzLnByb21vW1widGl0bGVcIl0gPSB0eHQucmVwbGFjZShyZ3gxMCwgJycpOyBcbiAgICAgICAgICAgICAgICB0aGlzLnByb21vW1wicHJpY2VcIl0gPSB0eHQubWF0Y2gocmd4MTApWzBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZih0eHQuc2VhcmNoKHJneDExKSAhPSAtMSkgeyBcbiAgICAgICAgICAgICAgICB0aGlzLnByb21vW1widGl0bGVcIl0gPSB0eHQucmVwbGFjZShyZ3gxMSwgJycpO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvbW9bXCJwcmljZVwiXSA9IHR4dC5tYXRjaChyZ3gxMSlbMF07IFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICB9XG59XG5hcHAuY29udHJvbGxlcignUHJvbW9EZXRhaWxDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGh0dHAnLCAnJHN0YXRlUGFyYW1zJywgJyRxJywgJyR0cmFuc2xhdGUnLCAnUHJvbW9TZXJ2aWNlJywgVG9tZWRlc2NvbnRvcy5Qcm9tb0RldGFpbENvbnRyb2xsZXJdKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
